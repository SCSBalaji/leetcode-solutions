name: Daily Consistency Reminder

on:
  schedule:
    # Runs at 9:00 PM IST (3:30 PM UTC) every day
    - cron: '30 15 * * *'
  
  # Manual trigger for testing
  workflow_dispatch:

jobs:
  check-consistency:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for commit checking
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Check today's commits and streak
        id: check
        run: |
          python << 'EOF'
          import subprocess
          import os
          from datetime import datetime, timedelta
          
          def get_commits_on_date(date_str):
              """Get commits that modified problem folders on a specific date."""
              cmd = f'git log --oneline --after="{date_str} 00:00" --before="{date_str} 23:59" -- "1. easy/" "2. medium/" "3. hard/"'
              result = subprocess.run(cmd, shell=True, capture_output=True, text=True)
              commits = [c for c in result.stdout.strip().split('\n') if c]
              return commits
          
          def calculate_streak():
              """Calculate current solving streak."""
              streak = 0
              check_date = datetime.now() - timedelta(days=1)  # Start from yesterday
              
              while True:
                  date_str = check_date.strftime('%Y-%m-%d')
                  commits = get_commits_on_date(date_str)
                  
                  if commits:
                      streak += 1
                      check_date -= timedelta(days=1)
                  else:
                      break
                  
                  # Safety limit
                  if streak > 365:
                      break
              
              return streak
          
          def count_total_problems():
              """Count total problems solved."""
              total = 0
              for difficulty in ['1. easy', '2. medium', '3. hard']:
                  if os.path.exists(difficulty):
                      for range_folder in os.listdir(difficulty):
                          range_path = os.path.join(difficulty, range_folder)
                          if os.path.isdir(range_path):
                              total += len([d for d in os.listdir(range_path) if os.path.isdir(os.path.join(range_path, d))])
              return total
          
          # Check today's commits
          today = datetime.now().strftime('%Y-%m-%d')
          today_commits = get_commits_on_date(today)
          
          # Calculate streak
          current_streak = calculate_streak()
          total_problems = count_total_problems()
          
          # Add today to streak if committed
          if today_commits:
              current_streak += 1
          
          print(f"Today's date: {today}")
          print(f"Commits today: {len(today_commits)}")
          print(f"Current streak: {current_streak} days")
          print(f"Total problems: {total_problems}")
          
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              if today_commits:
                  f.write("committed=true\n")
                  f.write(f"commit_count={len(today_commits)}\n")
              else:
                  f.write("committed=false\n")
              f.write(f"streak={current_streak}\n")
              f.write(f"total={total_problems}\n")
          
          # Create email body if no commits
          if not today_commits:
              if current_streak > 0:
                  streak_msg = f"âš ï¸ Your {current_streak}-day streak is at risk!"
                  urgency = "Don't break the chain!"
              else:
                  streak_msg = "ğŸŒ± Start a new streak today!"
                  urgency = "Every expert was once a beginner."
              
              email_body = f"""ğŸ”” LeetCode Daily Reminder
          {'='*45}

          Hey! You haven't solved any problem today.

          {streak_msg}

          ğŸ“Š Your Stats:
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          â€¢ Current Streak: {current_streak} days
          â€¢ Total Solved: {total_problems} problems
          â€¢ Date: {datetime.now().strftime('%B %d, %Y')}
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

          ğŸ’¡ {urgency}

          Quick Tips:
          â€¢ Start with an Easy problem if short on time
          â€¢ Even 1 problem a day = 365 problems a year!
          â€¢ Consistency beats intensity

          ğŸš€ Commands to get started:
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          python scripts/create_problem.py <num> "<title>" <diff> "<topics>"
          python scripts/batch_operations.py stats

          Keep grinding! ğŸ’ª
          """
              
              with open('reminder_email.txt', 'w') as f:
                  f.write(email_body)
          
          EOF
      
      - name: Send reminder email
        if: steps.check.outputs.committed == 'false'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "âš ï¸ LeetCode Reminder: Don't break your streak! (Day ${{ steps.check.outputs.streak }})"
          body: file://reminder_email.txt
          to: ${{ secrets.EMAIL_TO }}
          from: LeetCode Streak Bot <${{ secrets.EMAIL_USERNAME }}>
      
      - name: Already committed today
        if: steps.check.outputs.committed == 'true'
        run: |
          echo "âœ… Great job! You already committed today!"
          echo "ğŸ“Š Commits today: ${{ steps.check.outputs.commit_count }}"
          echo "ğŸ”¥ Current streak: ${{ steps.check.outputs.streak }} days"
          echo "ğŸ“ˆ Total problems: ${{ steps.check.outputs.total }}"